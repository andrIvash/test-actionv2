name: Move Assigned Issue to In Progress

on:
  issues:
    types: [assigned]

jobs:
  move:
    name: Move
    runs-on: ubuntu-latest
    steps:
      - name: Move issue to In Progress
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECTS_MOVE }}
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // GraphQL query to get the project and issue information
            const query = `
              query($owner: String!, $repo: String!, $issueNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issueNumber) {
                    id
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                          title
                        }
                      }
                    }
                  }
                }
              }
            `;

            // Fetch the issue details and associated project items
            const result = await github.graphql(query, {
              owner: owner,
              repo: repo,
              issueNumber: issueNumber
            });

            const issueId = result.repository.issue.id;
            const projectItems = result.repository.issue.projectItems.nodes;

            // Find the project item for the specific project
            const projectItem = projectItems.find(item => item.project.title === "test1-project");

            if (projectItem) {
              const projectItemId = projectItem.id;
              const projectId = projectItem.project.id;

              // GraphQL mutation to move the project item to In Progress
              const mutation = `
                mutation($projectItemId: ID!, $status: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId,
                    itemId: $projectItemId,
                    field: "status",
                    value: { name: $status }
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;

              await github.graphql(mutation, {
                projectId: projectId,
                projectItemId: projectItemId,
                status: "In Progress"
              });

              console.log(`Moved issue #${issueNumber} to "In Progress"`);
            } else {
              console.log(`Issue #${issueNumber} is not part of the specified project`);
            }
